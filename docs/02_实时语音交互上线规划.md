# 实时语音交互 3-4 周上线规划（单机首发，ASR/Agent/TTS 全真实）

## 摘要

目标是在 4 周内把当前 MVP 提升为“可上线、可观测、可回滚”的首发版本。  
范围聚焦单机/单实例生产可用性，不做多实例调度平台化。  
主线按 4 个里程碑推进：链路稳定化 -> 体验与时延 -> 可观测与运维 -> 上线演练与验收。

## 范围与成功标准

- 范围内：
  1. 实时语音链路稳定（ASR streaming + Agent + TTS 全真实）
  2. 端到端体验可接受（回撤可控、打断可用、延迟受控）
  3. 生产运维可执行（日志、指标、告警、配置分层、回滚）
  4. 上线验收可量化（有固定测试集和通过阈值）
- 范围外：
  1. 多实例水平扩展与服务网格
  2. 多租户计费系统
  3. 复杂前端产品化界面
- 成功标准（首发门槛）：
  1. 端到端 P95 首字响应延迟可观测并稳定在目标阈值内
  2. 关键错误率（ASR失败、Agent超时、TTS失败）低于约定阈值
  3. 真实回归集通过率达到约定阈值
  4. 出现故障时可在 10 分钟内切换到降级模式（Mock 或兜底策略）

## 里程碑计划（4 周）

## 实施进展（截至 2026-02-07）

- M1 已启动并完成首批落地：
  1. 已新增 `RuntimeProfile(dev/test/prod)` 与三套环境模板配置。
  2. 已新增 `Resilience`（timeout/retry/circuit-break）并接入 ASR/Agent/TTS 主链路。
  3. 已升级 `/healthz` 为依赖分项探针输出（asr/agent/tts）。
  4. 已统一错误结构为 `traceId + error.stage + error.code`。
  5. 已补充 `Fallback`（Agent 失败兜底文本）配置与执行路径。
  6. 已补充错误码和降级策略文档：`docs/03_M1错误码与降级策略.md`。

- M1 剩余工作（进行中）：
  1. 完成 2 小时稳定压测并沉淀压测报告。
  2. 补齐真实依赖断开场景（FunASR/GLM/Kokoro）自动化回归用例。
  3. 固化“全真实链路”门槛阈值（通过率、错误率、超时率）并形成 M1 验收记录。

- M2 已完成核心能力落地：
  1. endpointing 分档：新增 `quiet/noisy` profile，按噪声动态切换。
  2. partial 稳定升级：前缀冻结 + 尾部改写阈值抑制字幕抖动。
  3. two-pass 触发优化：按 `endpointing|max_segment|listen_stop` 和最小时长触发。
  4. 打断机制上线：用户开口时立即中断 TTS，并下发 `interrupt` 事件。
  5. 新增 M2 自动化测试：`TtsInterruptTests`、`EndpointingEngineTests` 增补 profile 与 final reason 覆盖。

- M3 已完成核心能力落地：
  1. 指标补齐：`/metrics` 增加 stage 级成功/失败、错误率、avg/p95 延迟、interrupt 计数。
  2. 结构化日志：关键链路日志统一携带 `sessionId/segmentId/traceId/finalReason`。
  3. 告警规则：新增 `/alerts`，支持错误率、延迟、依赖健康告警。
  4. 发布与回滚：新增 `/releasez` 和 `Release:ForceMock*` 强制降级开关。
  5. 新增 M3 自动化测试：`AlertsTests`、`AsrPipelineMetricsTests`。

- M4 已完成文档与流程冻结：
  1. 固定验收集定义：`docs/04_M4固定验收集定义.md`。
  2. 验收报告模板：`docs/05_M4验收报告模板.md`。
  3. 发布与回滚手册：`docs/06_M4发布与回滚手册.md`。
  4. Go/No-Go 决策单：`docs/07_M4上线GoNoGo决策单.md`。

### M1（第 1 周）：真实链路稳定化

- 目标：
  1. 打通并固定 `FunASR/ManySpeech + GLM + Kokoro` 全真实配置
  2. 清理“能跑但不稳”的随机失败点
- 主要工作（示例）：
  1. 配置分层：本地开发/测试/生产三套配置模板与环境变量约束
  2. 依赖健康探针：ASR/Agent/TTS 启动前自检与运行时探活
  3. 超时与重试策略：统一 timeout、重试次数、熔断窗口
  4. 错误码标准化：把链路错误统一为可追踪分类（网络/鉴权/模型/数据）
- 验收：
  1. 连续 2 小时稳定压测无崩溃
  2. 关键依赖断开时有明确错误回传和降级路径
  3. `dotnet test` 全绿，真实集成测试通过率达到门槛

### M2（第 2 周）：实时体验与时延优化

- 目标：
  1. 解决“字幕抖动、回撤过大、打断不自然”
  2. 把时延优化到可用区间
- 主要工作（示例）：
  1. endpointing 参数分档（安静/噪声）与动态切换
  2. partial 稳定策略升级（前缀冻结 + 尾部回撤窗口）
  3. two-pass 触发策略优化（长静音/窗口满/显式 stop）
  4. 打断机制：用户说话时 TTS 立即停播并切回听写
- 验收：
  1. 交互脚本回放下，回撤长度与 final 偏差在阈值内
  2. 首字/整句延迟 P50/P95 达标
  3. 打断成功率达标，且无明显“说话抢占失败”

### M3（第 3 周）：可观测性与上线保障

- 目标：
  1. 建立“发现问题 -> 定位 -> 处置”的闭环
  2. 把上线风险降到可控
- 主要工作（示例）：
  1. 指标补齐：会话、分段、ASR耗时、Agent耗时、TTS耗时、失败率
  2. 结构化日志：`sessionId/segmentId/requestId` 全链路透传
  3. 告警规则：错误率突增、延迟突增、依赖不可达
  4. 发布与回滚：版本标识、配置开关、一键降级策略
- 验收：
  1. 任一失败样本可在 5 分钟内定位到链路节点
  2. 告警可触发且无明显噪音
  3. 回滚演练通过（切换降级模式成功）

### M4（第 4 周）：上线演练与验收冻结

- 目标：
  1. 完成灰度前总验收与文档冻结
  2. 给出上线 Go/No-Go 结论
- 主要工作（示例）：
  1. 构建固定验收集：安静/噪声/方言/快语速/中英混说/长句/打断
  2. 执行端到端回归（功能、性能、稳定性）
  3. 形成发布清单：风险、已知问题、应急预案
  4. 冻结配置与版本，准备灰度
- 验收：
  1. 验收集通过率达标
  2. 关键 SLA 指标达标
  3. 运营值班手册可执行

## 公共接口/类型变更（需明确并冻结）

- WebSocket 协议建议新增或标准化字段：
  1. `traceId`：全链路追踪
  2. `latencyMs`：阶段耗时（stt/agent/tts）
  3. `error.code` 与 `error.stage`：统一错误语义
  4. `finalReason`：`endpointing|listen_stop|max_segment|timeout`
  5. `interrupt` 事件：标识 TTS 被打断原因与时间点
- 配置接口建议补充：
  1. `AsrMvp:RuntimeProfile`（dev/test/prod）
  2. `AsrMvp:Resilience:*`（超时、重试、熔断）
  3. `AsrMvp:Sla:*`（延迟和错误率阈值）
  4. `AsrMvp:Fallback:*`（依赖失败时降级策略）

## 测试计划与场景

- 自动化测试：
  1. 单元测试：endpointing 状态机边界、partial 稳定器、two-pass 窗口逻辑
  2. 集成测试：真实 ASR/Agent/TTS 组合下的 happy path 与异常路径
  3. 性能测试：并发会话、长会话、高噪声流输入
- 验收场景（示例）：
  1. 连续讲话 30s，无静音，验证强制切段与延迟
  2. 噪声环境（键盘/风噪），验证误触发率
  3. 中英夹杂术语，验证最终文本稳定性
  4. 用户中途打断 TTS，验证 stop->listen 切换时序
  5. 外部依赖超时，验证降级与错误回传
- 通过标准：
  1. 功能通过率、性能阈值、稳定性阈值均达标
  2. 无 P0/P1 缺陷遗留

## 风险与对应策略

- 风险：
  1. 三个真实依赖同时在线时，超时链式放大
  2. two-pass 提升准确率但拉高最终延迟
  3. TTS 打断时序与播放缓冲竞争导致体验抖动
- 对策：
  1. 分阶段 timeout + 熔断 + 降级兜底
  2. two-pass 限窗与异步回补策略
  3. 打断优先级最高，并清空待播缓冲

## 交付物清单

1. 上线配置模板与环境变量文档
2. 协议字段说明（含错误码）
3. 监控与告警面板定义
4. 验收报告（功能/性能/稳定性）
5. 发布与回滚手册

## 假设与默认决策

1. 首发为单机/单实例，不做多实例会话粘性设计
2. 首发坚持 ASR/Agent/TTS 全真实，不默认 Mock
3. 规划周期按 4 周执行，若压缩到 3 周则优先完成 M1-M3，M4 缩为 2-3 天冻结验收
4. 当前仓库 `src/VoiceAgent.AsrMvp` 为唯一生产基线，`referense-code/` 仅参考
