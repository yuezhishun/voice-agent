# M1 错误码与降级策略（2026-02-07）

## 目标

为 `streaming` 链路统一错误语义，确保 ASR / Agent / TTS 在失败时可追踪、可降级、可验收。

## 标准错误结构

WebSocket 错误事件：

```json
{
  "type": "stt",
  "state": "error",
  "sessionId": "...",
  "traceId": "...",
  "error": {
    "stage": "decode|asr|agent|tts|transport|session",
    "code": "...",
    "detail": "..."
  }
}
```

说明：
- `traceId`：同一请求链路追踪 ID。
- `error.stage`：错误所处阶段。
- `error.code`：稳定错误码，可用于告警聚合。
- `error.detail`：运行时详情，不作为稳定契约。

## 错误码清单（M1）

- `transport`
  - `UNSUPPORTED_MESSAGE`
- `decode`
  - `DECODE_FAIL`
- `asr`
  - `ASR_TIMEOUT`
  - `ASR_PROVIDER_ERROR`
  - `ASR_CIRCUIT_OPEN`
- `agent`
  - `AGENT_TIMEOUT`
  - `AGENT_PROVIDER_ERROR`
  - `AGENT_CIRCUIT_OPEN`
- `tts`
  - `TTS_TIMEOUT`
  - `TTS_PROVIDER_ERROR`
  - `TTS_CIRCUIT_OPEN`
- `session`
  - `INTERNAL_ERROR`

## 降级策略

- ASR 失败：返回标准错误事件，等待下一段 `streaming` 音频继续。
- Agent 失败：当 `AsrMvp:Fallback:EnableOnAgentFailure=true` 时，输出 `AgentFallbackText` 作为兜底回复。
- TTS 失败：返回标准错误事件，保留文字结果，停止当前音频输出。

## 韧性参数

- `AsrMvp:Resilience:Asr:*`
- `AsrMvp:Resilience:Agent:*`
- `AsrMvp:Resilience:Tts:*`

每个 stage 支持：
- `TimeoutMs`
- `RetryCount`
- `CircuitBreakFailures`
- `CircuitBreakWindowSeconds`

## 端到端示例（input -> ASR -> Agent -> TTS）

1. 客户端发送 `streaming` PCM16 音频。
2. 服务输出 `stt.partial`（携带 `traceId` 和 `latencyMs.stt`）。
3. 触发 final 后输出 `stt.final`（携带 `finalReason`）。
4. 调用 Agent 成功后输出 `agent.response`。
5. 调用 TTS 成功后输出 `tts.start/chunk/stop`。
6. 若 Agent 超时，则输出 `stt.error`：`error.stage=agent`、`error.code=AGENT_TIMEOUT`，并按配置输出兜底文本。

## 验收映射

- 对应 `docs/02_实时语音交互上线规划.md` 的 M1-4：错误码标准化。
- 对应 `docs/08_ASR验收检查清单.md` 的 M1 专项：
  - 错误语义统一
  - 降级策略可执行
