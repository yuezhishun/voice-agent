# M4 发布与回滚手册（单机首发）

## 发布前检查

1. `dotnet build src/voice-agent.sln` 通过。
2. `dotnet test src/VoiceAgent.AsrMvp.Tests/VoiceAgent.AsrMvp.Tests.csproj` 全绿。
3. `/healthz` 返回 `status=ok` 或可解释的 `degraded`。
4. `/alerts` 无 `critical` 告警。
5. `Release:Version` 已更新。

## 发布步骤

1. 冻结配置：固定 `RuntimeProfile` 与 `Release:Version`。
2. 启动服务并记录启动日志。
3. 执行 smoke：
   - WebSocket `stt.partial` / `stt.final`
   - `agent.response`
   - `tts.start/chunk/stop`
   - `interrupt.stop`（打断场景）
4. 导出发布快照：
   - `/metrics`
   - `/alerts`
   - `/releasez`

## 回滚触发条件

满足任一条件立即回滚：

1. `critical` 告警持续 > 3 分钟。
2. stage 错误率（ASR/Agent/TTS）超过阈值 2 倍并持续 > 5 分钟。
3. 打断链路失效（`interrupt` 事件明显缺失）。

## 回滚步骤（10 分钟内）

1. 开启强制降级开关（按故障 stage）：
   - `AsrMvp:Release:ForceMockAsr=true`
   - `AsrMvp:Release:ForceMockAgent=true`
   - `AsrMvp:Release:ForceMockTts=true`
2. 重启服务使配置生效。
3. 验证 `/releasez` 显示 `mock(forced)`。
4. 重新执行 smoke 并确认业务可用。
5. 记录回滚原因与时间线。

## 事故记录模板

- 触发时间：
- 触发规则：
- 影响范围：
- 回滚开关：
- 恢复时间：
- 后续修复计划：
